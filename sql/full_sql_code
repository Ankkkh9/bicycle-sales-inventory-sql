---Q1: Calc Quantity of items, Sales value & Order quantity by each Subcategory in L12M


--- Present data of Month-Year, name of subcategory, sale value & order quantity
SELECT DISTINCT FORMAT_TIMESTAMP('%b %Y', TIMESTAMP(sale.ModifiedDate)) AS Period,
      subcat.name AS name,
      SUM(sale.OrderQty) AS qty_item,
      SUM(sale.LineTotal) AS sale_value,
      COUNT(DISTINCT sale.SalesOrderID) AS order_qty

FROM `adventureworks2019.Sales.SalesOrderDetail` AS sale
  
LEFT JOIN `adventureworks2019.Production.Product` AS product_defi
    ON sale.ProductID =product_defi.ProductID

LEFT JOIN `adventureworks2019.Production.ProductSubcategory` AS subcat
    ON CAST(product_defi.ProductSubcategoryID AS INT64) = subcat.ProductSubcategoryID
    
---Filter L12M     
WHERE date(sale.ModifiedDate) >= (SELECT DATE_SUB(DATE(MAX(ModifiedDate)) , INTERVAL 12 MONTH)
                                               FROM `adventureworks2019.Sales.SalesOrderDetail`)
GROUP BY 1,2
ORDER BY 2;

---Q2: Calc % YoY growth rate by SubCategory & release top 3 cat with highest grow rate. Can use metric: quantity_item. Round results to 2 decimal
---qty_diff = qty_item / prv_qty - 1

---Extract data that have full year
WITH raw_data AS(SELECT 
                    EXTRACT(YEAR FROM sale.ModifiedDate) AS year,
                    subcat.name AS name,
                    SUM(sale.OrderQty) AS qty_item

                  FROM `adventureworks2019.Sales.SalesOrderDetail` AS sale

                  LEFT JOIN `adventureworks2019.Production.Product` AS product_defi
                    ON sale.ProductID = product_defi.ProductID

                  LEFT JOIN `adventureworks2019.Production.ProductSubcategory` AS subcat
                    ON CAST(product_defi.ProductSubcategoryID AS INT64) = subcat.ProductSubcategoryID

                  WHERE EXTRACT(YEAR FROM sale.ModifiedDate) IN (SELECT EXTRACT(YEAR FROM ModifiedDate)
                                                                  FROM `adventureworks2019.Sales.SalesOrderDetail`
                                                                  GROUP BY EXTRACT(YEAR FROM ModifiedDate)
                                                                  HAVING COUNT( DISTINCT EXTRACT(MONTH FROM ModifiedDate)) = 12)

                  GROUP BY 1, 2
                  ORDER BY 2),

--- define the latest year & previous year
latest_years AS (
  SELECT MAX(year) AS latest_year,
    MAX(year) - 1 AS prev_year
  FROM raw_data),

---Break current year & previous year in quantity
 raw2 AS(SELECT year,
                name,
                qty_item,
                LAG(qty_item) OVER (PARTITION BY name ORDER BY year) AS prv_qty
        FROM raw_data),

--- calculate %YOY growth & ranking
raw3 AS(SELECT name, qty_item, prv_qty, 
      ROUND((qty_item/prv_qty -1),2) AS qty_diff,
      DENSE_RANK() OVER(ORDER BY (qty_item/prv_qty -1) DESC) AS rnk
        FROM raw2
        WHERE year = (SELECT latest_year FROM latest_years)
        AND qty_item IS NOT NULL AND prv_qty IS NOT NULL)

SELECT name, qty_item, prv_qty, qty_diff
FROM raw3
WHERE rnk<=3
ORDER BY rnk;


---Q3: Ranking Top 3 TeritoryID with biggest Order quantity of every year. If there's TerritoryID with same quantity in a year, do not skip the rank number
WITH raw1 AS(SELECT EXTRACT(YEAR FROM sale.ModifiedDate) AS year, TerritoryID, SUM(sale.OrderQty) AS qty_item,
        FROM `adventureworks2019.Sales.SalesOrderDetail` AS sale

        LEFT JOIN `adventureworks2019.Sales.SalesOrderHeader` AS header
            ON sale.SalesorderID =header.SalesorderID

        GROUP BY 1,2), 
---Ranking by quantity item
raw2 AS(SELECT year, TerritoryID, qty_item, 
                DENSE_RANK() OVER(PARTITION BY year ORDER BY qty_item DESC) AS rnk 
        FROM raw1)

SELECT * 
FROM raw2 
WHERE rnk <=3 
ORDER BY year DESC;


---Q4: Calc Total Discount Cost belongs to Seasonal Discount for each SubCategory

---total discount cost = %discount * quantity discount * price unit discount


--- calculate total discount cost
WITH raw1 AS(SELECT EXTRACT(YEAR FROM sale.ModifiedDate) AS year,
      subcat.name AS name,
      DiscountPCT*UnitPrice*OrderQty AS total_cost,
      offer.Type

                  FROM `adventureworks2019.Sales.SpecialOffer` AS offer

                  LEFT JOIN `adventureworks2019.Sales.SalesOrderDetail` AS sale
                    ON offer.SpecialofferID = sale.SpecialofferID

                  LEFT JOIN `adventureworks2019.Production.Product` AS product_defi
                    ON sale.ProductID = product_defi.ProductID

                  LEFT JOIN `adventureworks2019.Production.ProductSubcategory` AS subcat
                    ON CAST(product_defi.ProductSubcategoryID AS INT64) = subcat.ProductSubcategoryID

                  WHERE EXTRACT(YEAR FROM sale.ModifiedDate) IN (SELECT EXTRACT(YEAR FROM ModifiedDate)
                                                                  FROM `adventureworks2019.Sales.SalesOrderDetail`
                                                                  GROUP BY EXTRACT(YEAR FROM ModifiedDate)
                                                                  HAVING COUNT( DISTINCT EXTRACT(MONTH FROM ModifiedDate)) = 12))

---Filter by seasonal discount
SELECT year, name,
      ROUND(SUM(total_cost),2) AS cost,
FROM raw1
WHERE Type LIKE '%Seasonal Discount%'
GROUP BY year, name
ORDER BY year;

---Q5: Retention rate of Customer in 2014 with status of Successfully Shipped (Cohort Analysis)

---Step 1: create month & count customer in all month
WITH rawdata AS(SELECT customerID,
                  EXTRACT(MONTH FROM ModifiedDate) AS month,
                FROM `adventureworks2019.Sales.SalesOrderHeader`
                WHERE EXTRACT(YEAR FROM ModifiedDate) = 2014
                      AND status = 5
                ORDER BY month),

---Step 2: Find the opening month
      opening AS(SELECT customerID, 
                  MIN(EXTRACT(MONTH FROM ModifiedDate)) AS opening_m
                  FROM `adventureworks2019.Sales.SalesOrderHeader`
                  WHERE EXTRACT(YEAR FROM ModifiedDate) = 2014
                        AND status = 5
                  GROUP BY customerID)


SELECT opening_m AS month_join,
      CONCAT('M - ',month-opening_m) AS month_diff,
      COUNT(distinct rawdata.customerID)
FROM rawdata
LEFT JOIN opening
ON rawdata.customerID = opening.customerID
GROUP BY 1,2
ORDER BY month_join, month_diff;


---Q6: Trend of Stock level & MoM diff % by all product in 2011. If %gr rate is null then 0. Round to 1 decimal

---Choose facts which need in the formula
WITH raw1 AS(SELECT b.name,
                SUM(StockedQty) AS cur_stock,
                  EXTRACT(MONTH FROM a.ModifiedDate) AS month,
                  EXTRACT(YEAR FROM a.ModifiedDate) AS year
            FROM `adventureworks2019.Production.WorkOrder` as a
            LEFT JOIN `adventureworks2019.Production.Product` as b
            ON a.ProductID = b.ProductID
            WHERE EXTRACT(YEAR FROM a.ModifiedDate) = 2011
            GROUP BY 1,3,4)

---Calculate previous stock quantity & difference
SELECT name, month, year, cur_stock,
      LAG(cur_stock) OVER(PARTITION BY name ORDER BY month) AS pre_stock,
      ROUND(IFNULL(cur_stock/LAG(cur_stock) OVER(PARTITION BY name ORDER BY month)-1,0)*100,1) AS diff
FROM raw1
ORDER BY name, month DESC;



---Q7: Calc Ratio of Stock / Sales in 2011 by product name, by month

---Order results by month desc, ratio desc. Round Ratio to 1 decimal mom yoy

---OUTPUT: product name, product id, month, year, stock, sale, ratio

---Data from sale table
WITH sale AS(SELECT a.productID, b.name,
                EXTRACT(YEAR FROM a.ModifiedDate) AS year,
                EXTRACT(MONTH FROM a.ModifiedDate) AS month,
                sum(OrderQty) AS order_qty
            FROM `adventureworks2019.Sales.SalesOrderDetail` AS a
            LEFT JOIN `adventureworks2019.Production.Product` AS b
            ON a.ProductID = b.ProductID
            WHERE EXTRACT(YEAR FROM a.ModifiedDate) = 2011
            GROUP BY 1,2,3,4),

--Data stocks
    stock AS(SELECT productID, 
                    EXTRACT(YEAR FROM c.ModifiedDate) AS year,
                    EXTRACT(MONTH FROM c.ModifiedDate) AS month,
                    sum(StockedQty) AS stock_qty
            FROM `adventureworks2019.Production.WorkOrder` AS c
            WHERE EXTRACT(YEAR FROM ModifiedDate) = 2011
            GROUP BY 1,2,3)

---concat stock & sale and calculate ratio
SELECT sale.*, stock_qty,
      round(stock_qty/order_qty,1) AS ratio
FROM sale
LEFT JOIN stock
ON sale.productID = stock.productID AND sale.year = stock.year AND sale.month = stock.month
ORDER BY month DESC, ratio DESC;

---Q8: No of order and value at Pending status in 2014

SELECT EXTRACT(YEAR FROM ModifiedDate) AS year,
      status,
      count(distinct PurchaseOrderID) as order_Cnt,
      ROUND(SUM(totaldue),2) AS value
FROM  `adventureworks2019.Purchasing.PurchaseOrderHeader` 
WHERE status = 1 AND EXTRACT(YEAR FROM ModifiedDate) = 2014
GROUP BY 1,2;





